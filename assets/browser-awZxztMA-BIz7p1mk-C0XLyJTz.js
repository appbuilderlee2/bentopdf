import{s as M,p as l,j as p,q as m,k as y}from"./embedpdf-YjTIsOgS.js";const h="TaskQueue",g="Queue";var o=(c=>(c[c.CRITICAL=3]="CRITICAL",c[c.HIGH=2]="HIGH",c[c.MEDIUM=1]="MEDIUM",c[c.LOW=0]="LOW",c))(o||{});class f{constructor(e={}){this.queue=[],this.running=0,this.resultTasks=new Map,this.idleListeners=new Set;const{concurrency:t=1,comparator:r,ranker:n,onIdle:i,maxQueueSize:u,autoStart:s=!0,logger:a}=e;this.logger=a??new M,this.opts={concurrency:Math.max(1,t),comparator:r,ranker:n,onIdle:i??(()=>{}),maxQueueSize:u??Number.POSITIVE_INFINITY,autoStart:s}}setComparator(e){this.opts.comparator=e}setRanker(e){this.opts.ranker=e}size(){return this.queue.length}inFlight(){return this.running}isIdle(){return this.queue.length===0&&this.running===0}async drain(){this.isIdle()||await new Promise(e=>{const t=()=>{this.isIdle()&&(this.offIdle(t),e())};this.onIdle(t)})}notifyIdle(){this.isIdle()&&([...this.idleListeners].forEach(e=>e()),this.idleListeners.clear(),this.opts.onIdle())}onIdle(e){this.idleListeners.add(e)}offIdle(e){this.idleListeners.delete(e)}enqueue(e,t={}){const r=this.generateId(),n=t.priority??1,i=new l;if(this.queue.length>=this.opts.maxQueueSize){const a=new Error("Queue is full (maxQueueSize reached).");return i.reject(a),i}this.resultTasks.set(r,i);const u={id:r,priority:n,meta:t.meta??e.meta,executeFactory:e.execute};this.queue.push(u),this.logger.debug(h,g,`Task enqueued: ${r} | Priority: ${n} | Running: ${this.running} | Queued: ${this.queue.length}`);const s=i.abort.bind(i);return i.abort=a=>{this.logger.debug(h,g,`Task aborted: ${r}`),this.cancel(r),s(a)},this.opts.autoStart&&this.process(t.fifo===!0),i}cancel(e){const t=this.queue.length;this.queue=this.queue.filter(r=>r.id!==e||(r.cancelled=!0,!1)),this.resultTasks.delete(e),t!==this.queue.length&&(this.logger.debug(h,g,`Task cancelled and removed: ${e}`),this.kick())}kick(){queueMicrotask(()=>this.process())}async process(e=!1){for(this.logger.debug(h,g,`process() called | Running: ${this.running} | Concurrency: ${this.opts.concurrency} | Queued: ${this.queue.length}`);this.running<this.opts.concurrency&&this.queue.length>0;){this.logger.debug(h,g,`Starting new task | Running: ${this.running} | Queued: ${this.queue.length}`),e||this.sortQueue();const t=this.queue.shift();if(t.cancelled){this.logger.debug(h,g,`Skipping cancelled task: ${t.id}`);continue}const r=this.resultTasks.get(t.id);r&&(this.running++,(async()=>{let n=null;try{if(n=t.executeFactory(),!n)throw new Error("Task factory returned null/undefined");n.wait(i=>{r.state.stage===0&&r.resolve(i)},i=>{r.state.stage===0&&(i.type==="abort"?r.abort(i.reason):r.reject(i.reason))}),n.onProgress(i=>{r.progress(i)}),await n.toPromise()}catch(i){r.state.stage===0&&r.reject(i)}finally{this.resultTasks.delete(t.id),this.running--,this.logger.debug(h,g,`Task completed: ${t.id} | Running: ${this.running} | Queued: ${this.queue.length}`),this.isIdle()?this.notifyIdle():this.queue.length>0&&this.kick()}})().catch(n=>{this.logger.error(h,g,"Unhandled error in task execution wrapper:",n),this.running=Math.max(0,this.running-1),this.isIdle()?this.notifyIdle():this.queue.length>0&&this.kick()}))}}sortQueue(){const{comparator:e,ranker:t}=this.opts;if(e)return void this.queue.sort(e);const r=new Map,n=i=>t?(r.has(i.id)||r.set(i.id,t(i)),r.get(i.id)):this.defaultRank(i);this.queue.sort((i,u)=>{if(i.priority!==u.priority)return u.priority-i.priority;const s=n(i),a=n(u);return s!==a?a-s:this.extractTime(i.id)-this.extractTime(u.id)})}defaultRank(e){return 0}generateId(){return typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2)}`}extractTime(e){const t=Number(e.split("-")[0]);return Number.isFinite(t)?t:0}}const x="PdfEngine",I="Orchestrator";class E{constructor(e,t){this.executor=e,this.logger=t.logger??new M,this.options={imageConverter:t.imageConverter,fetcher:t.fetcher??(typeof fetch<"u"?(r,n)=>fetch(r,n):void 0),logger:this.logger},this.workerQueue=new f({concurrency:1,autoStart:!0,logger:this.logger}),this.logger.debug(x,I,"PdfEngine orchestrator created")}chunkArray(e,t){const r=[];for(let n=0;n<e.length;n+=t)r.push(e.slice(n,n+t));return r}isSupport(e){const t=new l;return t.resolve([p.Create,p.Read,p.Update,p.Delete]),t}destroy(){const e=new l;try{this.executor.destroy(),e.resolve(!0)}catch(t){e.reject({code:m.Unknown,message:String(t)})}return e}openDocumentUrl(e,t){const r=new l;return(async()=>{try{if(!this.options.fetcher)throw new Error("Fetcher is not set");const n=await this.options.fetcher(e.url,t?.requestOptions),i=await n.arrayBuffer(),u={id:e.id,content:i};this.openDocumentBuffer(u,{password:t?.password}).wait(s=>r.resolve(s),s=>r.fail(s))}catch(n){r.reject({code:m.Unknown,message:String(n)})}})(),r}openDocumentBuffer(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.openDocumentBuffer(e,t),meta:{docId:e.id,operation:"openDocumentBuffer"}},{priority:o.CRITICAL})}getMetadata(e){return this.workerQueue.enqueue({execute:()=>this.executor.getMetadata(e),meta:{docId:e.id,operation:"getMetadata"}},{priority:o.MEDIUM})}setMetadata(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.setMetadata(e,t),meta:{docId:e.id,operation:"setMetadata"}},{priority:o.MEDIUM})}getDocPermissions(e){return this.workerQueue.enqueue({execute:()=>this.executor.getDocPermissions(e),meta:{docId:e.id,operation:"getDocPermissions"}},{priority:o.MEDIUM})}getDocUserPermissions(e){return this.workerQueue.enqueue({execute:()=>this.executor.getDocUserPermissions(e),meta:{docId:e.id,operation:"getDocUserPermissions"}},{priority:o.MEDIUM})}getSignatures(e){return this.workerQueue.enqueue({execute:()=>this.executor.getSignatures(e),meta:{docId:e.id,operation:"getSignatures"}},{priority:o.MEDIUM})}getBookmarks(e){return this.workerQueue.enqueue({execute:()=>this.executor.getBookmarks(e),meta:{docId:e.id,operation:"getBookmarks"}},{priority:o.MEDIUM})}setBookmarks(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.setBookmarks(e,t),meta:{docId:e.id,operation:"setBookmarks"}},{priority:o.MEDIUM})}deleteBookmarks(e){return this.workerQueue.enqueue({execute:()=>this.executor.deleteBookmarks(e),meta:{docId:e.id,operation:"deleteBookmarks"}},{priority:o.MEDIUM})}renderPage(e,t,r){return this.renderWithEncoding(()=>this.executor.renderPageRaw(e,t,r),r,e.id,t.index,o.CRITICAL)}renderPageRect(e,t,r,n){return this.renderWithEncoding(()=>this.executor.renderPageRect(e,t,r,n),n,e.id,t.index,o.HIGH)}renderThumbnail(e,t,r){return this.renderWithEncoding(()=>this.executor.renderThumbnailRaw(e,t,r),r,e.id,t.index,o.MEDIUM)}renderPageAnnotation(e,t,r,n){return this.renderWithEncoding(()=>this.executor.renderPageAnnotationRaw(e,t,r,n),n,e.id,t.index,o.MEDIUM)}renderWithEncoding(e,t,r,n,i=o.CRITICAL){const u=new l,s=this.workerQueue.enqueue({execute:()=>e(),meta:{docId:r,pageIndex:n,operation:"render"}},{priority:i}),a=u.abort.bind(u);return u.abort=d=>{s.abort(d),a(d)},s.wait(d=>{u.state.stage===0&&this.encodeImage(d,t,u)},d=>{u.state.stage===0&&u.fail(d)}),u}encodeImage(e,t,r){const n=t?.imageType??"image/webp",i=t?.quality,u={data:new Uint8ClampedArray(e.data),width:e.width,height:e.height};this.options.imageConverter(()=>u,n,i).then(s=>r.resolve(s)).catch(s=>r.reject({code:m.Unknown,message:String(s)}))}getPageAnnotations(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageAnnotations(e,t),meta:{docId:e.id,pageIndex:t.index,operation:"getPageAnnotations"}},{priority:o.MEDIUM})}createPageAnnotation(e,t,r,n){return this.workerQueue.enqueue({execute:()=>this.executor.createPageAnnotation(e,t,r,n),meta:{docId:e.id,pageIndex:t.index,operation:"createPageAnnotation"}},{priority:o.MEDIUM})}updatePageAnnotation(e,t,r){return this.workerQueue.enqueue({execute:()=>this.executor.updatePageAnnotation(e,t,r),meta:{docId:e.id,pageIndex:t.index,operation:"updatePageAnnotation"}},{priority:o.MEDIUM})}removePageAnnotation(e,t,r){return this.workerQueue.enqueue({execute:()=>this.executor.removePageAnnotation(e,t,r),meta:{docId:e.id,pageIndex:t.index,operation:"removePageAnnotation"}},{priority:o.MEDIUM})}getAllAnnotations(e){const t=this.chunkArray(e.pages,500);this.logger.debug(x,I,`getAllAnnotations: ${e.pages.length} pages in ${t.length} chunks`);const r=new y({aggregate:n=>Object.assign({},...n)});return t.forEach((n,i)=>{const u=this.workerQueue.enqueue({execute:()=>this.executor.getAnnotationsBatch(e,n),meta:{docId:e.id,operation:"getAnnotationsBatch",chunkSize:n.length}},{priority:o.LOW});u.onProgress(s=>{r.progress({page:s.pageIndex,result:s.result})}),r.addChild(u,i)}),r.finalize(),r}getPageTextRects(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageTextRects(e,t),meta:{docId:e.id,pageIndex:t.index,operation:"getPageTextRects"}},{priority:o.MEDIUM})}searchAllPages(e,t,r){const n=Array.isArray(r?.flags)?r.flags.reduce((s,a)=>s|a,0):r?.flags??0,i=this.chunkArray(e.pages,25);this.logger.debug(x,I,`searchAllPages: ${e.pages.length} pages in ${i.length} chunks`);const u=new y({aggregate:s=>{const a=s.flatMap(d=>Object.values(d).flat());return{results:a,total:a.length}}});return i.forEach((s,a)=>{const d=this.workerQueue.enqueue({execute:()=>this.executor.searchBatch(e,s,t,n),meta:{docId:e.id,operation:"searchBatch",chunkSize:s.length}},{priority:o.LOW});d.onProgress(k=>{u.progress({page:k.pageIndex,results:k.result})}),u.addChild(d,a)}),u.finalize(),u}getAttachments(e){return this.workerQueue.enqueue({execute:()=>this.executor.getAttachments(e),meta:{docId:e.id,operation:"getAttachments"}},{priority:o.MEDIUM})}addAttachment(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.addAttachment(e,t),meta:{docId:e.id,operation:"addAttachment"}},{priority:o.MEDIUM})}removeAttachment(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.removeAttachment(e,t),meta:{docId:e.id,operation:"removeAttachment"}},{priority:o.MEDIUM})}readAttachmentContent(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.readAttachmentContent(e,t),meta:{docId:e.id,operation:"readAttachmentContent"}},{priority:o.MEDIUM})}setFormFieldValue(e,t,r,n){return this.workerQueue.enqueue({execute:()=>this.executor.setFormFieldValue(e,t,r,n),meta:{docId:e.id,pageIndex:t.index,operation:"setFormFieldValue"}},{priority:o.MEDIUM})}flattenPage(e,t,r){return this.workerQueue.enqueue({execute:()=>this.executor.flattenPage(e,t,r),meta:{docId:e.id,pageIndex:t.index,operation:"flattenPage"}},{priority:o.MEDIUM})}extractPages(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.extractPages(e,t),meta:{docId:e.id,pageIndexes:t,operation:"extractPages"}},{priority:o.MEDIUM})}extractText(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.extractText(e,t),meta:{docId:e.id,pageIndexes:t,operation:"extractText"}},{priority:o.MEDIUM})}redactTextInRects(e,t,r,n){return this.workerQueue.enqueue({execute:()=>this.executor.redactTextInRects(e,t,r,n),meta:{docId:e.id,pageIndex:t.index,operation:"redactTextInRects"}},{priority:o.MEDIUM})}getTextSlices(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getTextSlices(e,t),meta:{docId:e.id,slices:t,operation:"getTextSlices"}},{priority:o.MEDIUM})}getPageGlyphs(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageGlyphs(e,t),meta:{docId:e.id,pageIndex:t.index,operation:"getPageGlyphs"}},{priority:o.MEDIUM})}getPageGeometry(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.getPageGeometry(e,t),meta:{docId:e.id,pageIndex:t.index,operation:"getPageGeometry"}},{priority:o.MEDIUM})}merge(e){return this.workerQueue.enqueue({execute:()=>this.executor.merge(e),meta:{docId:e.map(t=>t.id).join(","),operation:"merge"}},{priority:o.MEDIUM})}mergePages(e){return this.workerQueue.enqueue({execute:()=>this.executor.mergePages(e),meta:{docId:e.map(t=>t.docId).join(","),operation:"mergePages"}},{priority:o.MEDIUM})}preparePrintDocument(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.preparePrintDocument(e,t),meta:{docId:e.id,operation:"preparePrintDocument"}},{priority:o.MEDIUM})}saveAsCopy(e){return this.workerQueue.enqueue({execute:()=>this.executor.saveAsCopy(e),meta:{docId:e.id,operation:"saveAsCopy"}},{priority:o.MEDIUM})}closeDocument(e){return this.workerQueue.enqueue({execute:()=>this.executor.closeDocument(e),meta:{docId:e.id,operation:"closeDocument"}},{priority:o.MEDIUM})}closeAllDocuments(){return this.workerQueue.enqueue({execute:()=>this.executor.closeAllDocuments(),meta:{operation:"closeAllDocuments"}},{priority:o.MEDIUM})}setDocumentEncryption(e,t,r,n){return this.workerQueue.enqueue({execute:()=>this.executor.setDocumentEncryption(e,t,r,n),meta:{docId:e.id,operation:"setDocumentEncryption"}},{priority:o.MEDIUM})}removeEncryption(e){return this.workerQueue.enqueue({execute:()=>this.executor.removeEncryption(e),meta:{docId:e.id,operation:"removeEncryption"}},{priority:o.MEDIUM})}unlockOwnerPermissions(e,t){return this.workerQueue.enqueue({execute:()=>this.executor.unlockOwnerPermissions(e,t),meta:{docId:e.id,operation:"unlockOwnerPermissions"}},{priority:o.MEDIUM})}isEncrypted(e){return this.workerQueue.enqueue({execute:()=>this.executor.isEncrypted(e),meta:{docId:e.id,operation:"isEncrypted"}},{priority:o.MEDIUM})}isOwnerUnlocked(e){return this.workerQueue.enqueue({execute:()=>this.executor.isOwnerUnlocked(e),meta:{docId:e.id,operation:"isOwnerUnlocked"}},{priority:o.MEDIUM})}}class w extends Error{constructor(e){super(e),this.name="ImageConverterError"}}const D=(c,e="image/webp",t)=>{if(typeof document>"u")return Promise.reject(new w("document is not available. This converter requires a browser environment."));const r=c(),n=new ImageData(r.data,r.width,r.height);return new Promise((i,u)=>{const s=document.createElement("canvas");s.width=n.width,s.height=n.height,s.getContext("2d").putImageData(n,0,0),s.toBlob(a=>{a?i(a):u(new w("Canvas toBlob returned null"))},e,t)})};function P(c){return async(e,t="image/webp",r)=>{try{const n=e(),i=new Uint8ClampedArray(n.data);return await c.encode({data:i,width:n.width,height:n.height},t,r)}catch(n){return console.warn("Worker encoding failed, falling back to main-thread Canvas:",n),D(e,t,r)}}}export{E as h,D as l,P as p};
