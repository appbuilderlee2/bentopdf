import{i as C,g as A}from"./wasm-cdn-config-DzU6jbwW.js";import{P as D,a as l,b,c as F}from"./PDFButton-B7ekbw-1.js";let h=null;async function S(){const p=A("ghostscript"),e=p.endsWith("/")?p:`${p}/`,n=`${e}gs.js`,t=await fetch(n);if(!t.ok)throw new Error(`Failed to fetch gs.js: HTTP ${t.status}`);const r=await t.text(),c=new Blob([r],{type:"application/javascript"}),a=URL.createObjectURL(c);try{const o=(await import(a)).default;return await o({locateFile:i=>i.endsWith(".wasm")?`${e}gs.wasm`:`${e}${i}`,print:i=>console.log("[GS]",i),printErr:i=>console.error("[GS Error]",i)})}finally{URL.revokeObjectURL(a)}}async function I(p,e="PDF/A-2b",n){if(!C("ghostscript"))throw new Error("Ghostscript is not configured. Please configure it in WASM Settings.");n?.("Loading Ghostscript...");let t;h?t=h:(t=await S(),h=t);const r={"PDF/A-1b":"1","PDF/A-2b":"2","PDF/A-3b":"3"},c="/tmp/input.pdf",a="/tmp/output.pdf",s="/tmp/pdfa.icc",o="/tmp/pdfa.ps";t.FS.writeFile(c,p),console.log("[Ghostscript] Input file size:",p.length),n?.(`Converting to ${e}...`);try{const w="/bentopdf/sRGB_IEC61966-2-1_no_black_scaling.icc",g=await fetch(w);if(!g.ok)throw new Error(`Failed to fetch ICC profile from ${w}: HTTP ${g.status}`);const y=new Uint8Array(await g.arrayBuffer());console.log("[Ghostscript] sRGB v2 ICC profile loaded:",y.length,"bytes"),t.FS.writeFile(s,y),console.log("[Ghostscript] sRGB ICC profile written to FS:",s);const P=Array.from(y).map(m=>m.toString(16).padStart(2,"0")).join("");console.log("[Ghostscript] ICC profile hex length:",P.length);const G=`%!
% PDF/A definition file for ${e}

% Define the ICC profile stream object with embedded hex data
[/_objdef {icc_PDFA} /type /stream /OBJ pdfmark
[{icc_PDFA} << /N 3 >> /PUT pdfmark
[{icc_PDFA} <${P}> /PUT pdfmark

% Define the OutputIntent dictionary
[/_objdef {OutputIntent_PDFA} /type /dict /OBJ pdfmark
[{OutputIntent_PDFA} <<
  /Type /OutputIntent
  /S ${e==="PDF/A-1b"?"/GTS_PDFA1":"/GTS_PDFA"}
  /DestOutputProfile {icc_PDFA}
  /OutputConditionIdentifier (sRGB IEC61966-2.1)
  /Info (sRGB IEC61966-2.1)
  /RegistryName (http://www.color.org)
>> /PUT pdfmark

% Attach OutputIntent to the document Catalog
[{Catalog} << /OutputIntents [ {OutputIntent_PDFA} ] >> /PUT pdfmark
`;t.FS.writeFile(o,G),console.log("[Ghostscript] PDFA PostScript created with embedded ICC hex data")}catch(u){throw console.error("[Ghostscript] Failed to setup PDF/A assets:",u),new Error("Conversion failed: could not create PDF/A definition")}const i=["-dNOSAFER","-dBATCH","-dNOPAUSE","-sDEVICE=pdfwrite",`-dPDFA=${r[e]}`,"-dPDFACompatibilityPolicy=1",`-dCompatibilityLevel=${e==="PDF/A-1b"?"1.4":"1.7"}`,"-sColorConversionStrategy=UseDeviceIndependentColor","-sICCProfilesDir=/tmp/",`-sOutputICCProfile=${s}`,`-sDefaultRGBProfile=${s}`,`-sBlendColorProfile=${s}`,"-dCompressPages=true","-dWriteObjStms=false","-dWriteXRefStm=false","-dEmbedAllFonts=true","-dSubsetFonts=true","-dAutoRotatePages=/None",`-sOutputFile=${a}`,o,c];console.log("[Ghostscript] Running PDF/A conversion...");try{console.log("[Ghostscript] Checking version:"),t.callMain(["--version"])}catch(u){console.warn("[Ghostscript] Could not check version:",u)}let f;try{f=t.callMain(i)}catch(u){throw console.error("[Ghostscript] Exception:",u),new Error(`Ghostscript threw an exception: ${u}`)}if(console.log("[Ghostscript] Exit code:",f),f!==0){try{t.FS.unlink(c)}catch{}try{t.FS.unlink(a)}catch{}try{t.FS.unlink(s)}catch{}try{t.FS.unlink(o)}catch{}throw new Error(`Ghostscript conversion failed with exit code ${f}`)}let d;try{const u=t.FS.stat(a);console.log("[Ghostscript] Output file size:",u.size),d=t.FS.readFile(a)}catch(u){throw console.error("[Ghostscript] Failed to read output:",u),new Error("Ghostscript did not produce output file")}try{t.FS.unlink(c)}catch{}try{t.FS.unlink(a)}catch{}try{t.FS.unlink(s)}catch{}try{t.FS.unlink(o)}catch{}if(e!=="PDF/A-1b"){n?.("Post-processing for transparency compliance..."),console.log("[Ghostscript] Adding Group dictionaries to pages for transparency compliance...");try{d=await k(d),console.log("[Ghostscript] Page Group dictionaries added successfully")}catch(u){console.error("[Ghostscript] Failed to add Group dictionaries:",u)}}return d}async function k(p){const e=await D.load(p,{ignoreEncryption:!0,updateMetadata:!1}),t=e.catalog.lookup(l.of("OutputIntents"));let r;if(t instanceof b){const s=t.lookup(0);s instanceof F&&(r=s.get(l.of("DestOutputProfile")))}const c=s=>{if(!r)return;const o=s.get(l.of("CS"));if(o instanceof l){const i=o.decodeText();if(i==="DeviceRGB"||i==="DeviceGray"||i==="DeviceCMYK"){const f=e.context.obj([l.of("ICCBased"),r]);s.set(l.of("CS"),f)}}else if(!o){const i=e.context.obj([l.of("ICCBased"),r]);s.set(l.of("CS"),i)}},a=e.getPages();for(const s of a){const o=s.node,i=o.lookup(l.of("Group"));if(i)i instanceof F&&c(i);else if(r){const f=e.context.obj([l.of("ICCBased"),r]),d=e.context.obj({Type:"Group",S:"Transparency",I:!1,K:!1});d.set(l.of("CS"),f),o.set(l.of("Group"),d)}}return r&&e.context.enumerateIndirectObjects().forEach(([s,o])=>{if(o instanceof F||o&&typeof o=="object"&&"dict"in o){const i="dict"in o?o.dict:o,f=i.get(l.of("Subtype"));if(f instanceof l&&f.decodeText()==="Form"){const d=i.lookup(l.of("Group"));d instanceof F&&c(d)}}}),await e.save({useObjectStreams:!1,addDefaultPage:!1,updateFieldAppearances:!1})}async function x(p,e="PDF/A-2b",n){const t=await p.arrayBuffer(),r=new Uint8Array(t),c=await I(r,e,n),a=new Uint8Array(c.length);return a.set(c),new Blob([a],{type:"application/pdf"})}async function E(p,e){if(!C("ghostscript"))throw new Error("Ghostscript is not configured. Please configure it in WASM Settings.");e?.("Loading Ghostscript...");let n;h?n=h:(n=await S(),h=n);const t="/tmp/input.pdf",r="/tmp/output.pdf";n.FS.writeFile(t,p),e?.("Converting fonts to outlines...");const c=["-dNOSAFER","-dBATCH","-dNOPAUSE","-sDEVICE=pdfwrite","-dNoOutputFonts","-dCompressPages=true","-dAutoRotatePages=/None",`-sOutputFile=${r}`,t];let a;try{a=n.callMain(c)}catch(o){try{n.FS.unlink(t)}catch{}throw new Error(`Ghostscript threw an exception: ${o}`)}if(a!==0){try{n.FS.unlink(t)}catch{}try{n.FS.unlink(r)}catch{}throw new Error(`Ghostscript conversion failed with exit code ${a}`)}let s;try{s=n.FS.readFile(r)}catch{throw new Error("Ghostscript did not produce output file")}try{n.FS.unlink(t)}catch{}try{n.FS.unlink(r)}catch{}return s}async function T(p,e){const n=await p.arrayBuffer(),t=new Uint8Array(n),r=await E(t,e),c=new Uint8Array(r.length);return c.set(r),new Blob([c],{type:"application/pdf"})}export{T as a,E as b,x as c};
